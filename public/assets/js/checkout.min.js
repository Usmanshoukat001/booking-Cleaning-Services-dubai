let serverUrl = "https://toolicia.com/";
let domainName = "https://toolicia.com/";
const checkoutBtn = document.getElementById("mamo-checkout");
const consumerUrl = encodeURIComponent(window.location.href);

function getDomain(url) {
    const parts = url.split("/");
    if (url.startsWith("http://")) {
        return parts[0] + "//" + parts[2]
    } else if (url.startsWith("https://")) {
        return parts[0] + "//" + parts[2]
    } else {
        return null
    }
}

function addIframeToWebsite() {
    const urlObj = new URL(window.location.href);
    const params = new URLSearchParams(urlObj.search);
    const failedStatus = params.has("status") && params.get("status") === "failed";
    serverUrl = checkoutBtn.getAttribute("data-src");
    domainName = getDomain(serverUrl);
    const iframe = document.createElement("iframe");
    iframe.src = `${serverUrl}?consumer=${consumerUrl}`;
    iframe.setAttribute("crossorigin", "anonymous");
    iframe.setAttribute("id", "iframe-mamo-checkout");
    iframe.setAttribute("allowTransparency", "true");
    iframe.setAttribute("allow", "payment");
    iframe.allowTransparency = "true";
    iframe.style.backgroundColor = "transparent";
    iframe.style.position = "fixed";
    iframe.style.top = "0";
    iframe.style.left = "0";
    iframe.style.width = "100%";
    iframe.style.height = "100%";
    iframe.style.border = "0";
    iframe.style.display = failedStatus ? "block" : "none";
    iframe.style.zIndex = 99999;
    document.body.appendChild(iframe);
    iframe.onload = handleIframeLoaded
}

function handleIframeLoaded() {
    window.addEventListener("message", event => {
        const iframe = document.getElementById("iframe-mamo-checkout");
        if (event.origin !== domainName) {
            return
        }
        if (event.data === "closeIframe" || event.message === "closeIframe") {
            iframe.style.display = "none"
        }
        if (event.data === "checkout-complete" || event.message === "checkout-complete") {
            iframe.style.display = "none"
        }
        if (event.data === "connectionEstablished" || event.message === "connectionEstablished") {
            console.log("connection establised")
        }
        if (event.data.type && event.data.type === "confirmation_required") {
            iframe.style.display = "none";
            window.location.replace(event.data.payload)
        }
    })
}
window.onload = () => {
    addIframeToWebsite()
};
checkoutBtn.onclick = () => {
    try {
        const iframe = document.getElementById("iframe-mamo-checkout");
        iframe.style.display = "block"
    } catch (e) {
        console.error("#mamo-checkout.onClick() error - ", e)
    }
};